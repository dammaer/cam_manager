<p align="center">
<img src="images/logo.png">
</p>

## :mag:
- [Вступление](#Вступление)
- [Описание](#Описание)
    - [Что настраиваем на камерах?](#Что-настраиваем-на-камерах)
    - [Какие модели камер можно настроить?](#Какие-модели-камер-можно-настроить)
    - [Обновление прошивки камеры](#Обновление-прошивки-камеры)
- [Установка](#Установка)
- [Как пользоваться](#Как-пользоваться)
- [References](#References)

## Вступление:
![tg_msg](images/tg_msg.jpg)

Специалистам в компании где я работаю часто приходится настраивать большое количество ip камер. По дефолту они имеют статические адреса и необходимо заходить на каждую камеру и выполнять одни и те же рутинные операции: смена разрешения видео, указание ntp сервера, изменение пароля учётной записи, смена настроек сети и т.д.. Конечно же можно сохранить конфигурацию со всеми этими настройками и загружать их на следующие камеры, но не всегда это происходит корректно. Какие-то модели камер вообще не подхватывают сохраненную ранее конфигурацию и загружаются с настройками по-умолчанию.

![tears](images/tears.png)

Я решил облегчить их страдания чтобы они занимались другой более важной работой!

![fil](images/fil.jpg)

## Описание:
Моё решение основывается на использовании библиотеки [ONVIF Client Implementation in Python](https://github.com/yingchengpa/python-onvif2-zeep).

Для простого запуска весь код с помощью [pyinstaller](https://github.com/pyinstaller/pyinstaller) скомпилирован в бинарный файл и распространен ввиде утилиты на рабочие станции сотрудников.

![menu](images/menu.png)

Предполагается, что компьютер с которого происходит настройка камеры, находится в одной с ней сети и имеет второй ip-интерфейс из той же сети как и у камеры.

<details>
<summary><b>Схема</b></summary>
<img src="images/diagram.png"/>
</details>

**Есть два варианта режима работы утилиты:**
1. **Без привилегий sudo.** В данном случае необходим: 
    - Какой-то роутер с которого можно получить lease info зная mac-адрес камеры (в нашем случае MikroTik). Для чего это нужно? Например мы меняем настройки сети на DHCP. После смены камера не выдаст свой новый полученный ip, а просто уйдет в ребут либо потеряется коннект. Узнать ip мы можем только на маршрутизаторе. Ещё пример, когда необходимо сбросить камеру к заводским настройкам не зная ip, а зная только mac. 
    - Управляемый POE коммутатор для настройки множества камер. Камеры по умолчанию могут иметь одинаковые ip адреса, поэтому мы можем настроить их только поочередно, опуская/поднимая порты на коммутаторе.
2. **C привилегиями sudo.** Привилегии нужны чтобы иметь возможность использовать определенные функции задействуя небезызвестную библитеку [scapy](https://github.com/secdev/scapy) (например отправка широковещательных ARP запросов). Роутер не нужен, POE коммутатор не обязателен (можно использовать только чтобы запитать сразу несколько камер). *Логика работы следующая: отправляем arp-запрос зная дефолтный ip-адрес -> получаем mac-адрес камеры -> добавляем статическую arp-запись -> производим настройку камеры -> удаляем arp-запись -> переходим к настройке следующей камеры.*

Конфигурация камер заранее описывается в файлах json для конкретных моделей. Пример: [OMNY-miniBullet2EWDU.json](configs/cam/OMNY/OMNY-miniBullet2EWDU.json).

**На данный  момент утилита умеет:**
- обновлять камеру до последней рабочей версии прошивки (где работает коридорый режим и т.д.)
- настраивать одну камеру
- несколько в режиме настройки с помощью управляемого POE коммутатора
- настраивать одну или несколько камер, если запустить утилиту с **sudo** (*без использования управляемого POЕ коммутатора*)
- сбрасывать камеры к заводским настройкам
____
### Что настраиваем на камерах?
- Основной видеопоток (разрешение, качество, битрейт)
- Дополнительный видеопоток (разрешение)
- Убираем лишнюю системную информацию с видеопотока (оставляем только дату и время)
- Отключаем запись с микрофона (иначе будет шипение при записи в архив если микрофон не подключен)
- Таймзона
- NTP сервер
- Создание дополнительного пользователя с правами только на просмотр
- Изменение пароля у пользователя admin
- Смена настроек сети на DHCP
____
### Какие модели камер можно настроить?
<details>
<summary>OMNY</summary>
OMNY A52N 36<br>
OMNY A52SN 36<br>
OMNY A55N 36<br>
OMNY A55SN 28<br>
OMNY A55SN 36<br>
OMNY-ViBe5EZWDU<br>
OMNY-miniBullet2EWDU<br>
OMNY-miniBullet5EWDU<br>
OMNY-miniDome2EWD12V<br>
OMNY-miniDome2EWDU<br>
OMNY-miniDome2M<br>
OMNY-miniDome2M12Vv3<br>
OMNY-miniDome2WDUv3<br>
OMNY-miniDome4WDU<br>
OMNY-miniDome5EU<br>
OMNY-miniDome5EUv2<br>
OMNY_A54N<br>
OMNY_A55N_28
</details>
<details>
<summary>DAHUA</summary>
DH-IPC-HDW2230TP-AS-0280B<br>
DH-IPC-HFW2231TP-ZS
</details>

____
### Обновление прошивки камеры
Обновление прошивки камеры происходит автоматически. Перед конфигурацией утилита проверяет версию прошивки и сравнивает с той в которой все работает (например коридорный режим).

![update](images/update.png)

[:arrow_up: В начало](#mag)

## Установка:

## References:
* [ONVIF operations index](http://www.onvif.org/onvif/ver20/util/operationIndex.html)
* [ONVIF media2 service](https://www.onvif.org/onvif/ver20/media/wsdl/media.wsdl)
* [ONVIF Network Interface Specifications](https://www.onvif.org/profiles/specifications/)
* [ONVIF Network Interface Specifications Github](https://github.com/onvif/specs/tree/development/wsdl)
* [ONVIF Client Implementation in Python](https://github.com/yingchengpa/python-onvif2-zeep)
* [NAG - IP Видеокамеры](https://nag.wiki/pages/viewpage.action?pageId=25108910)